<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
  <title>
   SkyDRM
  </title>
  <link href="/rms/ui/img/favicon.ico" rel="icon" type="image/x-icon"/>
  <link href="/rms/ui/css/login.min.css?v=10.4.0227" rel="stylesheet"/>
  <link href="/rms/ui/css/font/fira.css?v=10.4.0227" rel="stylesheet"/>
  <link as="font" crossorigin="" href="/rms/ui/css/font/woff2/FiraSans-Regular.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="/rms/ui/css/font/woff2/FiraSans-Medium.woff2" rel="preload" type="font/woff2"/>
  <script src="/rms/ui/lib/jquery/jquery-1.10.2.min.js">
  </script>
  <script src="/rms/ui/app/login.min.js?v=10.4.0227">
  </script>
  <script src="/rms/ui/lib/3rdParty/core-min.js">
  </script>
  <script src="/rms/ui/lib/3rdParty/md5-min.js">
  </script>
  <script src="/rms/ui/lib/bootstrap/3.3.5/js/bootstrap.min.js">
  </script>
  <link href="/rms/tenants/skydrm.com/css/style.css?v=10.4.0227" rel="stylesheet" type="text/css"/>
  <script type="text/javascript">
   function redirectToTenantPage(page){
        var query = window.location.search;
        
        window.location.assign("/rms" + page + query);
    }
	function goToIntro(){
		redirectToTenantPage("/intro");
	}
	function goToLogin(){
		if(readCookie("adminApp") == "true") {
			redirectToTenantPage("/loginAdmin")
		} else {
			redirectToTenantPage("/login");
		}
	}
	function goToForgotPassword(){
		redirectToTenantPage("/forgotPassword");
	}
	function goToRegister(){
		redirectToTenantPage("/register");
	}
  </script>
 </head>
 <body>
  <div id="loading" style="top: 50%; left:50%; position: absolute;">
   <img src="ui/img/loading-icon.gif"/>
  </div>
  <div id="cont" style="display:none;">
   <div class="left-column small-screen-hide">
    <div class="login-left-column">
     <div class="inline-block cc-layout-full-width" style="padding: 50px 0 0 50px;">
      <div class="logo">
      </div>
     </div>
     <div>
      <img class="login-left-col" src="tenants/skydrm.com/images/login-screen-graphics.png"/>
      <div class="welcome-msg">
       Welcome to SkyDRM
      </div>
      <div class="description-msg">
       Protect, share, and monitor your documents securely anywhere
      </div>
     </div>
    </div>
   </div>
   <!-- page content -->
   <div class="right-column">
    <div class="login-right-column">
     <div class="wrapper">
      <div id="smaller-browser-control-partner-logos">
       <div id="browser-control-nxl-logo">
        <img id="nxl-logo-mobile" src="tenants/skydrm.com/images/logo-black.svg"/>
       </div>
      </div>
      <img class="rms-logo pointer-click" onclick="goToIntro()" src="/rms/ui/img/rms-logo-with-text.svg"/>
      <div class="subtitle">
       Log in to your account
      </div>
      <!-- content -->
      <div class="alert alert-danger alert-dismissable message" id="display-error">
       <button aria-hidden="true" class="close" onclick="closeDialog()" type="button">
        x
       </button>
       <span id="errmsg">
       </span>
      </div>
      <div class="login-box">
       <div class="input-layout">
        <input autocomplete="off" id="username" name="username" required="" tabindex="1" type="text"/>
        <label for="username">
         Email Address
        </label>
       </div>
       <div class="input-layout">
        <input autocomplete="off" id="password" name="password" required="" tabindex="2" type="password"/>
        <label for="password">
         Password
        </label>
       </div>
       <span class="hide-control" id="rememberMeSpan">
        <label class="noselect" style="font-weight:normal;margin-top:10px">
         <input id="rememberMe" tabindex="3" type="checkbox"/>
         Remember me
        </label>
        <br/>
       </span>
       <div style="margin-top: 20px;">
        <button class="btn btn-default rms-login-button" disabled="disabled" id="submit-btn" tabindex="4">
         Log In
        </button>
        <img class="loading" id="loading-login" src="ui/img/loading-icon.gif"/>
       </div>
       <div class="clearfix">
       </div>
       <div class="login-user-actions">
        <div id="forgot-password-div">
         <a class="pointer-click" onclick="forgotPassword()" tabindex="6">
          Forgot password?
         </a>
        </div>
        <div class="clearfix">
        </div>
        <div id="create-account-button-div">
         <a class="pointer-click" onclick="register()" tabindex="5">
          Create a new account
         </a>
        </div>
       </div>
       <div id="or-divider-div">
        <hr id="left-divider"/>
       </div>
       <div class="input-layout">
        <input autocomplete="off" id="ldap-username" name="ldap-username" required="" tabindex="7" type="text">
         <label for="ldap-username">
          Username
         </label>
        </input>
       </div>
       <div class="input-layout">
        <input autocomplete="off" id="ldap-password" name="ldap-password" required="" tabindex="8" type="password"/>
        <label for="ldap-password">
         Password
        </label>
       </div>
       <div class="input-layout">
        <select id="ldap-domain">
         <option value="2">
          qapf1.qalab01.nextlabs.com
         </option>
        </select>
       </div>
       <div style="margin-top: 20px;">
        <button class="btn btn-default rms-login-button" id="ldap-login-btn" tabindex="10">
         Log In
        </button>
        <img class="loading" id="loading-login" src="ui/img/loading-icon.gif"/>
       </div>
       <div id="or-divider-div">
        <hr id="left-divider"/>
       </div>
       <div style="font-size: 15px; font-weight: 500; margin-bottom: 20px;">
        Log in using an identity provider
       </div>
       <div style="margin-top: 20px;">
        <button class="btn btn-default rms-login-button" onclick='samlLogin("3")' style="width:auto; min-width: 140px; max-width: 275px;" tabindex="11">
         <span style="overflow: hidden; white-space: nowrap; display: block; text-overflow: ellipsis;">
          Log In using SAML - ADFS
         </span>
        </button>
        <img class="loading" id="loading-login" src="ui/img/loading-icon.gif"/>
       </div>
       <div id="or-divider-div">
        <hr id="left-divider"/>
       </div>
       <div class="form-group margin-bottom-10">
        <div style="font-size: 15px; font-weight: 500; margin-bottom: 20px;">
         Sign up / log in using your social account
        </div>
        <a class="pointer-click" id="googleLogin" tabindex="12">
         <img alt="Google" src="/rms/ui/img/Google_login.svg"/>
        </a>
       </div>
      </div>
      <div class="clearfix">
      </div>
     </div>
    </div>
    <div class="login-footer" id="footer">
     <center id="footer-links">
      <span tabindex="90">
       <a href="/rms/TermsAndConditions.html" target="_blank">
        Terms And Conditions
       </a>
      </span>
      <span tabindex="100">
       <a href="/rms/PrivacyPolicy.html" id="privacy-policy-anchor" target="_blank">
        Privacy Policy
       </a>
      </span>
      <span tabindex="110">
       <a href="mailto:support@skydrm.com">
        Contact Us
       </a>
      </span>
     </center>
    </div>
   </div>
  </div>
  <script type="text/javascript">
   setCookie("adminApp", "false");

            function register() {
                if($("#username").val() != "") {
                    var date = new Date();
                    date.setTime(date.getTime() + (5 * 60 * 1000)); // 5 minutes
                    setCookie("userEmail", $("#username").val(), date);
                }
                goToRegister();
            }

            function forgotPassword() {
                if($("#username").val() != "") {
                    var date = new Date();
                    date.setTime(date.getTime() + (5 * 60 * 1000)); // 5 minutes
                    setCookie("userEmail", $("#username").val(), date);
                }
                goToForgotPassword();
            }

            function loginRMS(data){
                if (isProjectInvitation(data) === false) {
                    goToMain(data.defaultTenantUrl);
                }
            }

            function isProjectInvitation(data) {
                var id = readCookie("id");
                var code = readCookie("code");

                var statusCode = 200;
                var jsonObj = {};
                if (id && code) {
                    /*
                    make call to accept API. if success, direct to project home
                    else take to the screen that show email address mismatch!

                    Delete cookies after accepting invite

                    */
                    $.ajax({
                        url: '/rms/rs/project/accept',
                        cache: false,
                        type: 'GET',
                        headers: {
                            'userId': data.userId,
                            'ticket': data.ticket,
                            'clientId': readCookie('clientId'),
                            'platformId':  readCookie('platformId')
                        },
                        data: {id: id, code: code},
                        async : false,
                        success: function (result) {
                           statusCode = result['statusCode'];
                           jsonObj = result['results'];
                        },
                        error: function (error) {
                            statusCode = 500;
                        }
                    });

                    deleteCookie("id");
                    deleteCookie("code");
                    var date = new Date();
                    date.setTime(date.getTime() + (5 * 60 * 1000)); // 5 minutes
                   if (statusCode == 200) {
                        setCookie("projectName", "null", date);
                        window.location.href = "main#/projects/" + jsonObj.projectId;
                        return true;
                   } else if (statusCode == 4003) {
                        setCookie("projectName", "null", date);
                        window.location.href = "main#/projects/emailMismatch";
                        return true;
                   }
                   // for other cases, and goto main page, set status code and show error message.
                   setCookie("statusCode", statusCode, date);
                }
                return false;
            }

            function goToMain(redirectUrl){
                deleteCookie("userEmail");
                
                	var url = redirectUrl ? redirectUrl + "/" : "";
                    window.location.href = url + "main";
                
            }

            function rmsLogin(){
                if(validateInputs()){
                    closeDialog();
                    $("#loading-login").show();
                    $("#submit-btn").attr("disabled", true);
                    $.post('/rms/rs/usr',
                        {
                            "email" :  $("#username").val(),
                            "password" : CryptoJS.MD5(($("#password").val())).toString(),
                            "rememberMe": $("#rememberMe").is(":checked"),
                            "tenant": "skydrmtest7513test_01"
                        }
                    ).done(function(data){
                        if(data.statusCode!= 200 || data.extra == null){
                        	var date = new Date();
                        	date.setTime(date.getTime() + (5 * 60 * 1000)); // 5 minutes
                        	setCookie("userEmail", $("#username").val(), date);
                            displayError(data.message);
                            $("#loading-login").hide();
                        	$("#submit-btn").attr("disabled", false);
                        }else{
                            loginRMS(data.extra);
                        }
                    }).fail(function() {
                        displayError("Could not connect to server.");
                        $("#loading-login").hide();
                        $("#submit-btn").attr("disabled", false);
                        return false;
                    });
                }
            }
            
            function ldapLogin(){
                var username = document.getElementById('ldap-username').value.trim();
                if(username == "") {
                    displayError("Please enter the username.");
                    $("#ldap-username").focus();
                    return false;
                }
                var password = document.getElementById('ldap-password').value.trim();
                if(password==""){
                    displayError("Please enter the password.");
                    $("#ldap-password").focus();
                    return false;
                }
                var idpId = document.getElementById('ldap-domain').value.trim();
                $.post('/rms/IdpManager/LdapAuth/LdapAuthFinish',
                        {
                            "userName" :  username,
                            "password" : password,
                            "id": idpId,
                            "tenant": "skydrmtest7513test_01",
                        }
                ).done(function(data){
                    $("#ldap-login-btn").attr("disabled", false);
                    if(data.code && data.code == '401') {
                        displayError("The username or password you entered is incorrect.");
                    } else if(data.code && data.code == '500l') {
                    	displayError("Error occurred while logging in with LDAP.");
                    } 
                    checkQueryParameters();
                }).fail(function(data) {
                    displayError("Error occurred while logging in with LDAP.");
                    $("#ldap-login-btn").attr("disabled", false);
                    return false;
                });
            }

            function validateInputs(){
                document.getElementById('username').value = document.getElementById('username').value.trim();
                var emailId=document.getElementById('username').value;
                if(emailId==""){
                    displayError("Please enter the Email Address.");
                    $("#username").focus();
                    return false;
                }
                var password=document.getElementById('password').value;
                if(password==""){
                    displayError("Please enter the password.");
                    $("#password").focus();
                    return false;
                }
                return validEmail();
            }

            var googleUser = {};

            function googleLogin() {
                showLoading();
                var search = window.location.search + ( window.location.search.match( /[\?]/g ) ? '&' : '?' ) + "tenant=skydrmtest7513test_01";
                window.location = '/rms/IdpManager/GoogleAuth/GoogleAuthStart' + search;
            }

            function facebookLogin() {
                showLoading();
                var search = window.location.search + ( window.location.search.match( /[\?]/g ) ? '&' : '?' ) + "tenant=skydrmtest7513test_01";
                window.location = '/rms/IdpManager/FacebookAuth/FacebookAuthStart' + search;
            }
            
            function samlLogin(idpId) {
                showLoading();
                var search = window.location.search + ( window.location.search.match( /[\?]/g ) ? '&' : '?' ) + 'id=' + idpId + "&tenant=skydrmtest7513test_01";
                window.location = '/rms/IdpManager/SamlAuth/SamlAuthStart' + search;
            }

            function onLoginSuccess(path, token){
                $.post(path, {"token" :  token, "tenant": 'skydrmtest7513test_01'}
                ).done(function(data){
                    if(data.statusCode!= 200 || data.extra == null){
                        displayError(data.message);
                        hideLoading();
                    }else{
                        loginRMS(data.extra);
                    }
                }).fail(function() {
                    displayError("Could not connect to server.");
                    hideLoading();
                    return false;
                })
            }

            function checkQueryParameters(){
                var userId = readCookie('userId');
                var ticket = readCookie('ticket');
                if(userId && ticket && userId != "" && ticket != ""){
                    if (isProjectInvitation({"userId":userId, "ticket":ticket}) === false) {
                        goToMain();
                    }
                    return;
                }
                var code = getParameterByName('code');
                if(code){
                    hideLoading();
                    $("#username").focus();
                    translateCode(code);
                    if(code == "200"){
                        var email = readCookie("userEmail");
                        if(email && email != ""){
                            $("#username").val(email);
                            $("#password").focus();
                        }
                    }
                    return;
                }

                
                    hideLoading();
                    var redirectUrl = decodeURIComponent(getParameterByName("r"));
                    if(redirectUrl.indexOf("/personal/viewSharedFile") !== -1) {
                        displaySuccess("Please log in to SkyDRM to access the shared file.");
                    } else if (redirectUrl.indexOf("/projects/") !== -1) {
                        displaySuccess("Please log in to SkyDRM to access the project space.");
                    }
                    var email = readCookie("userEmail");
                    if(email && email != "") {
                        $("#username").val(email);
                    }
//                        if (!jscd.mobile) {
//                            $("#password").focus();
//                        }
//                    } else {
//                        if (!jscd.mobile) {
//                            $("#username").focus();
//                        }
//                    }
                
            }

            function hideLoading(){
                $("#cont").show();
                $("#loading").hide();
                adjustRightColumnHeight();
            }

            function showLoading(){
                $("#cont").hide();
                $("#loading").show();
            }

            $(document).ready(function () {
                if (jscd.mobile) {
                    $("span#rememberMeSpan").remove();
                }
                if (!jscd.cookies) {
                    displayError("Cookies are disabled in your browser. Enable cookies in your browser and try again.");
                    return;
                } else if(isIE9OrBelow()){
                    displayError("We recommend using Internet Explorer version 10 or above.");
                }
                if (jscd.os == "iOS") {
                    $("input").addClass("ios-only");
                }
                $('#facebookLogin').click(facebookLogin);
                $('#googleLogin').click(googleLogin);
                $('#submit-btn').click(rmsLogin);
                $('#submit-btn').prop("disabled", false);
                $('#ldap-login-btn').click(ldapLogin);
                $('#ldap-login-btn').prop("disabled", false);
	            
	             
	            $(document).keydown(function(e) {
	                if(e.which == 13) {
	                    rmsLogin();
	                }
	            });
	            
	             
                
                
                
            })

            $(window).on("load", function() {
                checkQueryParameters();
            });
        
            $(window).bind("pageshow", function(event) {
                if (event.originalEvent.persisted) {
                    window.location.reload()
                }
            });
  </script>
 </body>
</html>
